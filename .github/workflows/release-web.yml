name: Release Web

on:
    release:
        types: [created]

permissions:
    contents: write
    packages: write
    id-token: write
    security-events: write

env:
    REGISTRY: ghcr.io
    WEB_IMAGE_NAME: ${{ github.repository }}-web

jobs:
    detect-changes:
        name: Detect Web Changes
        runs-on: ubuntu-latest
        outputs:
            web-changed: ${{ steps.changes.outputs.web }}
            version: ${{ steps.version.outputs.version }}
            tag: ${{ steps.version.outputs.tag }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from tag
              id: version
              run: |
                  if [ -n "${{ github.event.release.tag_name }}" ]; then
                    TAG_NAME="${{ github.event.release.tag_name }}"
                  else
                    TAG_NAME="${GITHUB_REF#refs/tags/}"
                  fi
                  VERSION="${TAG_NAME#v}"
                  echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Build version: $VERSION (tag: $TAG_NAME)"

            - name: Get changed files
              id: changed-files
              uses: tj-actions/changed-files@v45
              with:
                  files: |
                      web/godnsweb/**
                      charts/godnsweb/**
                  since_last_remote_commit: true

            - name: Check if web files changed
              id: changes
              run: |
                  # Get the previous tag
                  PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.tag }}^ 2>/dev/null || echo "")

                  if [ -z "$PREV_TAG" ]; then
                    echo "No previous tag found, building web"
                    echo "web=true" >> $GITHUB_OUTPUT
                  else
                    # Check if there are changes in web directory since last tag
                    CHANGED=$(git diff --name-only $PREV_TAG ${{ steps.version.outputs.tag }} | grep -E '^web/godnsweb/|^charts/godnsweb/' || true)
                    
                    if [ -n "$CHANGED" ]; then
                      echo "Web files changed since last release:"
                      echo "$CHANGED"
                      echo "web=true" >> $GITHUB_OUTPUT
                    else
                      echo "No web files changed since last release"
                      echo "web=false" >> $GITHUB_OUTPUT
                    fi
                  fi

    build-and-release-web:
        name: Build and Release Web
        needs: detect-changes
        if: needs.detect-changes.outputs.web-changed == 'true'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}
                  tags: |
                      type=semver,pattern={{version}},value=${{ needs.detect-changes.outputs.tag }}
                      type=semver,pattern={{major}}.{{minor}},value=${{ needs.detect-changes.outputs.tag }}
                      type=semver,pattern={{major}},value=${{ needs.detect-changes.outputs.tag }}
                      type=raw,value=latest,enable=${{ github.event.release.prerelease == false }}
                      type=sha,prefix=,format=short

            - name: Build and push Web Docker image
              id: docker_build
              uses: docker/build-push-action@v6
              with:
                  context: ./web/godnsweb
                  file: ./web/godnsweb/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  build-args: |
                      VERSION=${{ needs.detect-changes.outputs.version }}
                      BUILD_TIME=${{ github.event.release.created_at }}
                      GIT_COMMIT=${{ github.sha }}
                  cache-from: type=gha,scope=buildkit-web-${{ github.ref_name }}
                  cache-to: type=gha,mode=max,scope=buildkit-web-${{ github.ref_name }}
                  provenance: true
                  sbom: true

            - name: Install Helm
              uses: azure/setup-helm@v4
              with:
                  version: 'latest'

            - name: Update Helm Chart
              run: |
                  VERSION=${{ needs.detect-changes.outputs.version }}
                  DIGEST=${{ steps.docker_build.outputs.digest }}

                  # Update Chart.yaml version
                  sed -i "s/^version:.*/version: ${VERSION}/" charts/godnsweb/Chart.yaml
                  sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" charts/godnsweb/Chart.yaml

                  # Update values.yaml with new image tag and digest
                  sed -i "s|repository:.*|repository: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}|" charts/godnsweb/values.yaml
                  sed -i "s|tag:.*|tag: \"${VERSION}@${DIGEST}\"|" charts/godnsweb/values.yaml

                  echo "Updated Helm chart to version ${VERSION}"
                  cat charts/godnsweb/Chart.yaml

            - name: Package Helm Chart
              run: |
                  mkdir -p .helm-releases
                  helm package charts/godnsweb -d .helm-releases

            - name: Log in to Helm registry
              run: |
                  echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

            - name: Push Helm Chart
              run: |
                  VERSION=${{ needs.detect-changes.outputs.version }}
                  helm push .helm-releases/godnsweb-${VERSION}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm

            - name: Upload Web Release Assets
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      .helm-releases/godnsweb-*.tgz
                  body: |
                      ## Web UI Release ${{ needs.detect-changes.outputs.tag }}

                      ### Docker Image

                      **Multi-arch image (linux/amd64, linux/arm64):**
                      ```bash
                      docker pull ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}
                      ```

                      **Image Digest:**
                      ```
                      ${{ steps.docker_build.outputs.digest }}
                      ```

                      **Full image reference:**
                      ```
                      ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}@${{ steps.docker_build.outputs.digest }}
                      ```

                      ### Helm Chart

                      **Install via Helm:**
                      ```bash
                      helm install godnsweb oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm/godnsweb --version ${{ needs.detect-changes.outputs.version }}
                      ```

                      ### Security

                      - **Base Image**: Google Distroless (static-debian12:nonroot)
                      - **User**: Non-root (UID 65532)
                      - **Security Headers**: Enabled
                      - **Read-only Root Filesystem**: Yes
                      - **SBOM**: Included
                      - **Signed**: With Cosign

                      ### Installation

                      #### Using Docker:
                      ```bash
                      docker run -p 8080:8080 \
                        -e VITE_KEYCLOAK_URL=http://keycloak:8080 \
                        -e VITE_API_BASE_URL=http://godns-api:8080 \
                        ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}
                      ```

                      #### Using Kubernetes/Helm:
                      ```bash
                      helm install my-godnsweb oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm/godnsweb \
                        --version ${{ needs.detect-changes.outputs.version }} \
                        --set ingress.enabled=true \
                        --set ingress.hosts[0].host=godns.example.com
                      ```

            - name: Security scan with Trivy
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}
                  format: sarif
                  output: trivy-web-results.sarif

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: trivy-web-results.sarif
                  category: godnsweb

            - name: Generate SBOM
              uses: anchore/sbom-action@v0
              with:
                  image: ${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}
                  format: spdx-json
                  output-file: sbom-web.spdx.json
                  upload-artifact: true
                  upload-release-assets: true

            - name: Create release summary
              run: |
                  cat >> $GITHUB_STEP_SUMMARY <<EOF
                  # Web UI Release ${{ needs.detect-changes.outputs.tag }} Published! ðŸŽ‰

                  ## Artifacts

                  - ðŸ³ **Docker Image**: \`${{ env.REGISTRY }}/${{ env.WEB_IMAGE_NAME }}:${{ needs.detect-changes.outputs.version }}\`
                  - ðŸ“¦ **Helm Chart**: \`oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/helm/godnsweb:${{ needs.detect-changes.outputs.version }}\`

                  ## Image Details

                  - **Digest**: \`${{ steps.docker_build.outputs.digest }}\`
                  - **Platforms**: linux/amd64, linux/arm64
                  - **Base Image**: Google Distroless (Static, Debian 12)
                  - **Security**: Signed with Cosign, SBOM included

                  ## Security Features

                  - âœ… Non-root user (UID 65532)
                  - âœ… Read-only root filesystem
                  - âœ… No shell or package manager
                  - âœ… Minimal attack surface
                  - âœ… Security headers enabled
                  - âœ… SBOM included
                  - âœ… Vulnerability scanning

                  EOF

    skip-web-release:
        name: Skip Web Release
        needs: detect-changes
        if: needs.detect-changes.outputs.web-changed == 'false'
        runs-on: ubuntu-latest
        steps:
            - name: Notify skipped
              run: |
                  echo "No changes detected in web application since last release"
                  echo "Skipping web build and release"

                  cat >> $GITHUB_STEP_SUMMARY <<EOF
                  # Web UI Release Skipped â­ï¸

                  No changes detected in the web application since the last release.

                  The following paths were checked:
                  - \`web/godnsweb/**\`
                  - \`charts/godnsweb/**\`

                  To force a web release, make changes to the web application or Helm chart.
                  EOF
