# DNS Zone Export API

The GoDNS API now includes powerful export functionality that allows you to export your DNS zones to different DNS provider formats.

## Supported Export Formats

- **BIND** (`bind` or `zonefile`) - Standard BIND zone file format (RFC 1035)
- **CoreDNS** (`coredns`) - CoreDNS Corefile configuration with zone files
- **PowerDNS** (`powerdns`) - PowerDNS JSON API format

## API Endpoints

### Export All Zones

Export all DNS zones in your system.

```bash
GET /api/v1/export?format={format}
```

**Query Parameters:**
- `format` (optional): Export format - `bind`, `coredns`, `powerdns`, or `zonefile` (default: `bind`)

**Example:**
```bash
curl -X GET "http://localhost:14000/api/v1/export?format=bind"
```

### Export Single Zone

Export a specific DNS zone.

```bash
GET /api/v1/export/{domain}?format={format}
```

**Path Parameters:**
- `domain`: The domain name to export (e.g., `example.lan`)

**Query Parameters:**
- `format` (optional): Export format - `bind`, `coredns`, `powerdns`, or `zonefile` (default: `bind`)

**Example:**
```bash
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=coredns"
```

## Export Format Examples

### BIND Zone File Format

The BIND format is the most widely compatible format and can be used with:
- BIND DNS server
- PowerDNS (with zone file backend)
- Many other DNS servers

**Example BIND Export:**
```bash
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=bind" > example.lan.zone
```

**Output:**
```
; Zone file for example.lan.
; Generated by GoDNS
;
$ORIGIN example.lan.
$TTL 300

@       300     IN      SOA     ns1.example.lan. hostmaster.example.lan. (
                                1          ; Serial
                                3600       ; Refresh
                                1800       ; Retry
                                604800     ; Expire
                                300 )      ; Negative Cache TTL

; A Records
@       300     IN      A       192.168.1.1
www     300     IN      A       192.168.1.2

; MX Records
@       300     IN      MX      10 mail.example.lan.
```

### CoreDNS Format

The CoreDNS format provides both the Corefile configuration and the zone file content.

**Example CoreDNS Export:**
```bash
curl -X GET "http://localhost:14000/api/v1/export?format=coredns" > coredns-config.txt
```

**Output:**
```
# Zone: example.lan.
example.lan {
    file /etc/coredns/zones/db.example.lan
    log
    errors
}

# Zone file: db.example.lan
$ORIGIN example.lan.
$TTL 300

@       300     IN      SOA     ns1.example.lan. hostmaster.example.lan. 1 3600 1800 604800 300

@       300     IN      A       192.168.1.1
www     300     IN      A       192.168.1.2
```

### PowerDNS JSON Format

The PowerDNS format exports zones as JSON suitable for the PowerDNS HTTP API.

**Example PowerDNS Export:**
```bash
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=powerdns" > example.lan.json
```

**Output:**
```json
{
  "name": "example.lan.",
  "type": "Zone",
  "kind": "Master",
  "dnssec": false,
  "serial": 1,
  "rrsets": [
    {
      "name": "example.lan.",
      "type": "SOA",
      "ttl": 300,
      "records": [
        {
          "content": "ns1.example.lan. hostmaster.example.lan. 1 3600 1800 604800 300",
          "disabled": false
        }
      ]
    },
    {
      "name": "www.example.lan.",
      "type": "A",
      "ttl": 300,
      "records": [
        {
          "content": "192.168.1.2",
          "disabled": false
        }
      ]
    }
  ]
}
```

## Use Cases

### 1. Backup Your DNS Configuration

Export all zones to create a backup:
```bash
curl -X GET "http://localhost:14000/api/v1/export?format=bind" > dns-backup-$(date +%Y%m%d).zone
```

### 2. Migrate to Another DNS Server

Export zones in the format compatible with your target DNS server:

**To BIND:**
```bash
curl -X GET "http://localhost:14000/api/v1/export?format=bind" > /etc/bind/zones/imported-zones.conf
```

**To CoreDNS:**
```bash
# Export all zones
curl -X GET "http://localhost:14000/api/v1/export?format=coredns" > coredns-import.txt

# Split into Corefile and zone files manually
```

**To PowerDNS:**
```bash
# Export and import via API
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=powerdns" | \
  curl -X POST -H "Content-Type: application/json" \
       -d @- "http://powerdns-server:8081/api/v1/servers/localhost/zones"
```

### 3. Review Zone Configuration

Export a single zone for review:
```bash
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=bind"
```

### 4. Documentation and Auditing

Generate documentation of your DNS infrastructure:
```bash
# Export all zones in BIND format for documentation
curl -X GET "http://localhost:14000/api/v1/export?format=bind" > docs/dns-zones.txt
```

## Response Format

All export endpoints return:
- **Content-Type:** `text/plain; charset=utf-8`
- **Content-Disposition:** `attachment; filename="..."`
- **Body:** The exported zone configuration in the requested format

## Error Responses

### Invalid Format
```json
{
  "error": "Invalid format. Supported formats: coredns, powerdns, bind, zonefile"
}
```
HTTP Status: 400

### Zone Not Found
```json
{
  "error": "Zone not found"
}
```
HTTP Status: 404

### Internal Server Error
```json
{
  "error": "Failed to export zones"
}
```
HTTP Status: 500

## Integration Examples

### Using curl

```bash
# Export all zones in BIND format
curl -X GET "http://localhost:14000/api/v1/export?format=bind" -o zones.txt

# Export single zone in CoreDNS format
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=coredns" -o example-coredns.txt

# Export in PowerDNS format
curl -X GET "http://localhost:14000/api/v1/export/example.lan?format=powerdns" -o example.json
```

### Using Python

```python
import requests

# Export all zones
response = requests.get('http://localhost:14000/api/v1/export', 
                        params={'format': 'bind'})
if response.status_code == 200:
    with open('zones-backup.txt', 'w') as f:
        f.write(response.text)

# Export specific zone
response = requests.get('http://localhost:14000/api/v1/export/example.lan',
                        params={'format': 'powerdns'})
if response.status_code == 200:
    import json
    zone_data = json.loads(response.text.split('\n\n')[1])  # Skip comments
    print(json.dumps(zone_data, indent=2))
```

### Using JavaScript/Node.js

```javascript
const fetch = require('node-fetch');
const fs = require('fs');

// Export all zones
async function exportZones() {
    const response = await fetch('http://localhost:14000/api/v1/export?format=bind');
    const zones = await response.text();
    fs.writeFileSync('zones-backup.txt', zones);
    console.log('Zones exported successfully');
}

// Export specific zone
async function exportZone(domain, format = 'bind') {
    const response = await fetch(
        `http://localhost:14000/api/v1/export/${domain}?format=${format}`
    );
    
    if (response.ok) {
        const zoneData = await response.text();
        fs.writeFileSync(`${domain}-${format}.txt`, zoneData);
        console.log(`Zone ${domain} exported in ${format} format`);
    } else {
        console.error(`Failed to export zone: ${response.statusText}`);
    }
}

exportZones();
exportZone('example.lan', 'coredns');
```

## Notes

- The export functionality automatically adds SOA (Start of Authority) records if they're not present in your zones
- Domain names are properly normalized (with trailing dots) in the output
- The BIND format is the most portable and recommended for backups
- PowerDNS JSON format groups multiple records of the same name/type into RRsets
- CoreDNS format includes both the Corefile configuration and zone file content

## Testing the Export Feature

You can test the export functionality using the GoDNS CLI:

```bash
# First, create a test zone
curl -X POST http://localhost:14000/api/v1/zones \
  -H "Content-Type: application/json" \
  -d '{
    "domain": "test.lan",
    "records": [
      {"name": "test.lan.", "type": "A", "ttl": 300, "value": "192.168.1.1"},
      {"name": "www.test.lan.", "type": "A", "ttl": 300, "value": "192.168.1.2"}
    ]
  }'

# Export the zone
curl -X GET "http://localhost:14000/api/v1/export/test.lan?format=bind"
```
